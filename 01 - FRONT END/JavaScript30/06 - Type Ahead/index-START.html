<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Type Ahead üëÄ</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="https://fav.farm/üî•" />
  </head>
  <body>
    <form class="search-form">
      <input
        type="text"
        class="search"
        name="search"
        placeholder="City or State"
      />
      <ul class="suggestions">
        <li>Filter for a city</li>
        <li>or a state</li>
      </ul>
    </form>
    <script>
      /* ========================================================================
          CONFIGURATION ET VARIABLES GLOBALES
         ======================================================================== */

      // URL de l'API GitHub contenant un fichier JSON avec toutes les villes am√©ricaines
      // Cette API retourne un tableau d'objets avec les propri√©t√©s : city, state, population
      const endpoint =
        'https://gist.githubusercontent.com/Miserlou/c5cd8364bf9b2420bb29/raw/2bf258763cdddd704f8ffd3ea9a3e81d25e2c6f6/cities.json';

      // Variable globale pour stocker toutes les donn√©es des villes une fois r√©cup√©r√©es
      // Initialis√©e comme tableau vide, elle sera remplie par la fonction getDataApi()
      let cities = [];

      /* ========================================================================
          R√âCUP√âRATION DES DONN√âES DEPUIS L'API
         ======================================================================== */

      /**
       * Fonction asynchrone qui r√©cup√®re les donn√©es des villes depuis l'API externe
       * Utilise async/await pour g√©rer les op√©rations asynchrones de mani√®re propre
       */
      async function getDataApi() {
        try {
          // √âTAPE 1: Effectue une requ√™te HTTP GET vers l'endpoint
          // fetch() retourne une Promise qui se r√©sout avec un objet Response
          const storeDataApi = await fetch(endpoint);

          // √âTAPE 2: Convertit la r√©ponse HTTP en format JSON
          // .json() est une m√©thode asynchrone qui parse le body de la r√©ponse
          const responseDataApi = await storeDataApi.json();

          // √âTAPE 3: Stockage des donn√©es dans la variable globale
          // Permet √† toutes les autres fonctions d'acc√©der aux donn√©es
          cities = responseDataApi;

          // √âTAPE 4: Affichage dans la console pour d√©buggage
          // Permet de v√©rifier que les donn√©es ont √©t√© correctement charg√©es
          console.log(cities);
        } catch (error) {
          // Gestion d'erreur en cas de probl√®me avec l'API
          console.error('Erreur lors du chargement des donn√©es:', error);
        }
      }

      // Lancement imm√©diat du chargement des donn√©es au chargement de la page
      // Cette fonction s'ex√©cute d√®s que le script est lu par le navigateur
      getDataApi();

      /* ========================================================================
          FONCTION DE RECHERCHE ET AFFICHAGE DES R√âSULTATS
         ======================================================================== */

      /**
       * Fonction principale qui filtre les donn√©es et affiche les r√©sultats
       * D√©clench√©e √† chaque caract√®re tap√© dans le champ de recherche
       * @param {Event} event - L'√©v√©nement 'input' du champ de recherche
       */
      function searchValue(event) {
        // √âTAPE 1: FILTRAGE DES DONN√âES
        // Utilise la m√©thode filter() pour cr√©er un nouveau tableau avec seulement les villes correspondantes
        const data = cities.filter(
          (usa) =>
            // Recherche dans le nom de la ville (insensible √† la casse via toLowerCase)
            usa.city.toLowerCase().includes(event.target.value.toLowerCase()) ||
            // OU recherche dans le nom de l'√©tat (insensible √† la casse)
            usa.state.toLowerCase().includes(event.target.value.toLowerCase())
        );

        // √âTAPE 2: PR√âPARATION DU CONTENEUR D'AFFICHAGE
        // S√©lection de l'√©l√©ment HTML qui contiendra les r√©sultats
        const elementParent = document.querySelector('.suggestions');

        // Nettoyage complet du contenu pr√©c√©dent pour √©viter l'accumulation
        // innerHTML = "" supprime tous les √©l√©ments enfants
        elementParent.innerHTML = '';

        // √âTAPE 3: CR√âATION DYNAMIQUE DES √âL√âMENTS HTML
        // Boucle √† travers chaque ville filtr√©e pour cr√©er son √©l√©ment d'affichage
        for (const city of data) {
          // CR√âATION DE L'√âL√âMENT PRINCIPAL (LI)
          // Chaque r√©sultat sera dans un √©l√©ment <li> de la liste
          const li = document.createElement('li');

          // CR√âATION DU SPAN POUR VILLE ET √âTAT
          // Contiendra le nom de la ville et de l'√©tat avec mise en surbrillance
          const spanCity = document.createElement('span');

          // MISE EN SURBRILLANCE DU TEXTE RECHERCH√â
          // Cr√©ation d'une expression r√©guli√®re pour trouver le texte saisi
          // "gi" = global (toutes les occurrences) et insensible √† la casse
          const regex = new RegExp(event.target.value, 'gi');

          // Remplacement du texte correspondant par une version encadr√©e de <span class="hl">
          // Cela permettra de mettre en surbrillance les parties correspondantes
          const cityName = city.city.replace(
            regex,
            `<span class="hl">${event.target.value}</span>`
          );
          const stateName = city.state.replace(
            regex,
            `<span class="hl">${event.target.value}</span>`
          );

          // Assemblage du texte final : "Ville, √âtat"
          spanCity.innerHTML = `${cityName}, ${stateName}`;

          // CR√âATION DU SPAN POUR LA POPULATION
          // Contiendra le nombre d'habitants format√©
          const spanPopulation = document.createElement('span');

          // Formatage du nombre de population avec s√©parateurs de milliers
          // Number() convertit la cha√Æne en nombre, toLocaleString() formate avec des virgules
          spanPopulation.textContent = Number(city.population).toLocaleString(
            'en-US'
          );

          // ASSEMBLAGE DES √âL√âMENTS
          // Ajout des deux spans (ville/√©tat et population) dans l'√©l√©ment li
          li.appendChild(spanCity);
          li.appendChild(spanPopulation);

          // AJOUT √Ä LA LISTE DES SUGGESTIONS
          // Insertion de l'√©l√©ment li complet dans le conteneur ul.suggestions
          elementParent.appendChild(li);
        }
      }

      /* ========================================================================
          LIAISON DES √âV√âNEMENTS
         ======================================================================== */

      // S√©lection du champ de recherche dans le DOM
      // Utilise la classe CSS "search" pour identifier l'input
      const input = document.querySelector('.search');

      // Attachement de l'√©couteur d'√©v√©nement sur le champ de recherche
      // "input" : se d√©clenche √† chaque modification du contenu (chaque caract√®re tap√©/supprim√©)
      // searchValue : fonction callback qui sera ex√©cut√©e √† chaque d√©clenchement
      input.addEventListener('input', searchValue);

      // Note: L'√©v√©nement "input" est pr√©f√©rable √† "keyup" car il capture aussi
      // les modifications par copier/coller, glisser/d√©poser, etc.
    </script>
  </body>
</html>
